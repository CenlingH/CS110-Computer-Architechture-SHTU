#include "utils.h"
#include "gd32vf103_libopt.h"
#include "gd32vf103.h"
#include "systick.h"
#include "lcd/lcd.h"
#include <stdio.h>
#include <stdarg.h>
/* -----------------------------
 Description: Return 1 if button number ch is pressed
 			  Return 0 otherwise
----------------------------- */
const unsigned char PlayerImage[] = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 
  0x21, 0x04, 0x21, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x08, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 
};

const unsigned char PlayerOnGoalImage[] = {  
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x36, 0xf7, 0x36, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x36, 0xf7, 0x36, 0xff, 0xff, 0xff, 0xff, 
  0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 
  0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 
  0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 0xf7, 0x36, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x36, 0xf7, 0x36, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf7, 0x36, 0xf7, 0x36, 0xff, 0xff, 0xff, 0xff, 
  };

const unsigned char WallImage[] = {
  0xff, 0x76, 0xff, 0x32, 0xff, 0x76, 0xff, 0x32, 0xdd, 0x56, 0xb2, 0xcd, 0xb2, 0xcd, 
  0xff, 0x32, 0xfe, 0x42, 0xfe, 0xec, 0xfe, 0x42, 0x99, 0x47, 0x88, 0x03, 0x88, 0x03, 
  0xff, 0x76, 0xff, 0x32, 0xff, 0x32, 0xfe, 0x42, 0x90, 0xc5, 0x88, 0x03, 0xaa, 0x2b, 
  0xff, 0x32, 0xfe, 0x42, 0xff, 0x76, 0xff, 0x32, 0xb2, 0xcd, 0x88, 0x03, 0x88, 0x03, 
  0xff, 0x76, 0xff, 0x32, 0xfe, 0xec, 0xfe, 0x42, 0xb2, 0xcd, 0x88, 0x03, 0x88, 0x03, 
  0xff, 0x32, 0xfe, 0x42, 0xfe, 0xca, 0xfe, 0x42, 0xa1, 0xe9, 0x88, 0x03, 0xa1, 0x88, 
  0xff, 0x76, 0xfe, 0xca, 0xfe, 0x42, 0xff, 0x76, 0xd3, 0xc5, 0x88, 0x03, 0x88, 0x03, 
};

const unsigned char EmptyImage[] = {
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
  0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 0xaf, 0x9f, 
};

const unsigned char GoalImage[] = {
  0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 
  0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 
  0xa2, 0x55, 0xa2, 0x55, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 
  0xa2, 0x55, 0xa2, 0x55, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 
  0xa2, 0x55, 0xa2, 0x55, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 0xce, 0x1d, 
  0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 
  0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 0xa2, 0x55, 
};

const unsigned char BoxImage[] = {
  0xb6, 0xd8, 0x96, 0x54, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb6, 0xd8, 
  0x96, 0x54, 0x1c, 0x68, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb6, 0xd8, 0x5d, 0x6e, 
  0xff, 0xff, 0xff, 0xff, 0xb6, 0xd8, 0x96, 0x54, 0xb6, 0xd8, 0x5d, 0x6e, 0x1c, 0x68, 
  0xff, 0xff, 0xff, 0xff, 0x96, 0x54, 0x1c, 0x68, 0x96, 0x54, 0x1c, 0x68, 0xb6, 0xd8, 
  0xff, 0xff, 0xff, 0xff, 0xb6, 0xd8, 0x96, 0x54, 0xb6, 0xd8, 0x96, 0x54, 0x96, 0x54, 
  0xff, 0xff, 0xb6, 0xd8, 0x5d, 0x6e, 0x1c, 0x68, 0x96, 0x54, 0x1c, 0x68, 0xb6, 0xd8, 
  0xb6, 0xd8, 0x5d, 0x6e, 0x1c, 0x68, 0xb6, 0xd8, 0x96, 0x54, 0xb6, 0xd8, 0x4d, 0x0c, 
};

const unsigned char BoxOnGoalImage[] = {
  0xfd, 0xb7, 0xfc, 0xb3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xb7, 
  0xfc, 0xb3, 0xf0, 0xe5, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfd, 0xb7, 0xf2, 0xcc, 
  0xff, 0xff, 0xff, 0xff, 0xfd, 0xb7, 0xfc, 0xb3, 0xfd, 0xb7, 0xf2, 0xcc, 0xf0, 0xe5, 
  0xff, 0xff, 0xff, 0xff, 0xfc, 0xb3, 0xf0, 0xe5, 0xf3, 0x6e, 0xf0, 0xe5, 0xfd, 0xb7, 
  0xff, 0xff, 0xff, 0xff, 0xfd, 0xb7, 0xf3, 0x6e, 0xf2, 0x29, 0xf0, 0xe5, 0xfc, 0xb3, 
  0xff, 0xff, 0xfd, 0xb7, 0xf2, 0xcc, 0xf0, 0xe5, 0xf0, 0xe5, 0xf0, 0xe5, 0xfd, 0xb7, 
  0xfd, 0xb7, 0xf2, 0xcc, 0xf0, 0xe5, 0xf3, 0x6e, 0xfc, 0xb3, 0xfd, 0xb7, 0xf2, 0x29, 
};

void debug(const char *str){
    // LCD_Clear(WHITE);
    LCD_ShowString(0,0,str,RED);
    delay_1ms(1000);
}

//debug function, printf-like
void debugf(const char *format, ...){
    char str[100];
    va_list args;
    va_start(args, format);
    vsprintf(str, format, args);
    va_end(args);
    debug(str);
}

void slowDebugf(const char *format, ...){
    char str[100];
    va_list args;
    va_start(args, format);
    vsprintf(str, format, args);
    va_end(args);
    debug(str);
    delay_1ms(1000);
}

static int bottonCh[] = {JOY_LEFT, JOY_DOWN, JOY_UP, JOY_RIGHT, JOY_CTR, BUTTON_1, BUTTON_2};
static uint64_t lastPressTime[] = {0, 0, 0, 0, 0, 0, 0};

int Get_Button(int ch)
{
    
    for(int i = 0;i < 7;i++){
        if(bottonCh[i] == ch){
            uint64_t now = get_timer_value();
            uint64_t delta = now - lastPressTime[i];
            //if within 0.3s
            if(delta < (SystemCoreClock/4000.0 * 300)){
                return 0;
            }
            lastPressTime[i] = now;
        }
    }
    /* hack for new board*/
    if (ch != GPIO_PIN_13)
        return (int)(gpio_input_bit_get(GPIOA, ch));
    else
        return (int)(gpio_input_bit_get(GPIOC, ch));
}

/* -----------------------------
 Description: Return 1 if button BOOT0 ch is pressed
 			  Return 0 otherwise
----------------------------- */
static uint64_t Boot0lastPressTime = 0;
int Get_BOOT0(void)
{
    uint64_t now = get_timer_value();
    uint64_t delta = now - Boot0lastPressTime;
    //if within 0.3s
    if(delta < (SystemCoreClock/4000.0 * 300)){
        return 0;
    }
    Boot0lastPressTime = now;
    return (int)(gpio_input_bit_get(GPIOA, GPIO_PIN_8));
}

// typedef struct Object {
//         short logincalX; //logical x
//         short logincalY; //logical y
//         short physicalX; //physical x
//         short physicalY; //physical y
//         short physicalWidth; //physical width
//         short physicalHeight; //physical height
//         short renderZ; //render z, higher means on top. 
//         enum ObjectType type; //type of object
// } Object;

Object createObject(short logincalX, short logincalY, short physicalX, short physicalY, short physicalWidth, short physicalHeight, short renderZ, enum ObjectType type){
    Object obj;
    obj.logincalX = logincalX;
    obj.logincalY = logincalY;
    obj.physicalX = physicalX;
    obj.physicalY = physicalY;
    obj.physicalWidth = physicalWidth;
    obj.physicalHeight = physicalHeight;
    obj.renderZ = renderZ;
    obj.type = type;
    return obj;
}

Object createPlayer(short logicX,short logicY){
    short physicalX = logicX * 8;
    short physicalY = logicY * 8;
    //check if out of range
    if(physicalX < 0 || physicalX >= LCD_W || physicalY < 0 || physicalY >= LCD_H){
        return createObject(logicX,logicY,physicalX,physicalY,8,8,2,error);
    }
    return createObject(logicX,logicY,physicalX,physicalY,8,8,3,player);
}

Object createWall(short logicX,short logicY){
    short physicalX = logicX * 8;
    short physicalY = logicY * 8;
    //check if out of range
    if(physicalX < 0 || physicalX >= LCD_W || physicalY < 0 || physicalY >= LCD_H){
        return createObject(logicX,logicY,physicalX,physicalY,8,8,2,error);;
    }
    return createObject(logicX,logicY,physicalX,physicalY,8,8,2,wall);
}

Object createBox(short logicX,short logicY){
    short physicalX = logicX * 8;
    short physicalY = logicY * 8;
    //check if out of range
    if(physicalX < 0 || physicalX >= LCD_W || physicalY < 0 || physicalY >= LCD_H){
        return createObject(logicX,logicY,physicalX,physicalY,8,8,2,error);;
    }
    return createObject(logicX,logicY,physicalX,physicalY,8,8,2,box);
}

Object createGoal(short logicX,short logicY){
    short physicalX = logicX * 8;
    short physicalY = logicY * 8;
    //check if out of range
    if(physicalX < 0 || physicalX >= LCD_W || physicalY < 0 || physicalY >= LCD_H){
        return createObject(logicX,logicY,physicalX,physicalY,8,8,2,error);;
    }
    return createObject(logicX,logicY,physicalX,physicalY,8,8,1,goal);
}

Object createEmpty(short logicX,short logicY){
    short physicalX = logicX * 8;
    short physicalY = logicY * 8;
    //check if out of range
    if(physicalX < 0 || physicalX >= LCD_W || physicalY < 0 || physicalY >= LCD_H){
        return createObject(logicX,logicY,physicalX,physicalY,8,8,2,error);;
    }
    return createObject(logicX,logicY,physicalX,physicalY,8,8,0,empty);
}

// #define WHITE         	 0xFFFF
// #define BLACK         	 0x0000	  
// #define BLUE           	 0x001F  
// #define BRED             0XF81F
// #define GRED 			 0XFFE0
// #define GBLUE			 0X07FF
// #define RED           	 0xF800
// #define MAGENTA       	 0xF81F
// #define GREEN         	 0x07E0
// #define CYAN          	 0x7FFF
// #define YELLOW        	 0xFFE0
// #define BROWN 			 0XBC40 //brown
// #define BRRED 			 0XFC07 //maroon
// #define GRAY  			 0X8430 //gray

void renderObject(Object obj){
    // char str[20];
    // sprintf(str,"renderObject %d",obj.type);
    // debug(str);
    switch(obj.type){
        case player:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,PlayerImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,RED);
            break;
        case wall:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,WallImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,BLUE);
            break;
        case box:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,BoxImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,BROWN);            
            break;
        case goal:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,GoalImage);
            //LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,GREEN);
            break;
        case empty:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,EmptyImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,WHITE);
            break;
        case error:
            LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,GRAY);
            break;
        case boxOnGoal:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,BoxOnGoalImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,GRAY);
            break;
        case playerOnGoal:
            LCD_ShowImage(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,PlayerOnGoalImage);
            // LCD_Fill(obj.physicalX,obj.physicalY,obj.physicalX+obj.physicalWidth-2,obj.physicalY+obj.physicalHeight-1,MAGENTA);
            break;
    }
}

